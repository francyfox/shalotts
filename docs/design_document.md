### **Дизайн-документ: Genoplate - Универсальный Генератор Boilerplate**

**1. Обзор и Видение Проекта**
*   **Цель:** Создание универсального Rust-приложения для генерации boilerplate-ов, позволяющего разработчикам легко комбинировать модульные компоненты (фичи, библиотеки) в кастомные сборки для **Rust и TypeScript** проектов, и обеспечивающего воспроизводимость через "generation seeds".
*   **Проблема:** Существующие Git-шаблоны и некоторые генераторы ограничены в гибкости, управлении зависимостями и возможности компоновки произвольных фичей.
*   **Решение:** `Genoplate` предоставляет модульную систему, где каждый компонент является "строительным блоком", который может быть выбран, сконфигурирован и сгенерирован в готовую проектную структуру.
*   **Целевая аудитория:** Разработчики, команды, создатели библиотек, которым требуется быстро создавать новые проекты с заранее определенным набором технологий и настроек.

**2. Ключевые Принципы Дизайна**
*   **Модульность:** Каждая "фича" (например, UI-фреймворк, база данных, линтер) является независимым, конфигурируемым модулем.
*   **Универсальность:** Возможность для пользователей определять и регистрировать собственные "сборки" (коллекции фичей с конфигурациями) для **различных языков программирования (Rust, TypeScript)**.
*   **Декларативность:** Определение boilerplate-ов и их логики через конфигурационные файлы (например, TOML или YAML).
*   **Гибкость:** Поддержка условной логики, преобразований файлов и хуков после генерации.
*   **Воспроизводимость:** Генерация "seed" — уникального идентификатора (хеша) входных параметров (выбранных boilerplate'ов, их версий и конфигураций), позволяющего точно воспроизвести процесс генерации. Seed кодирует *инструкции*, а не сам результат.
*   **Безопасность:** Минимизация рисков конфликтов и ошибок через систему правил и зависимостей.

**3. Архитектура Системы (Высокоуровневая)**

```
+-------------------+      +-------------------------+
|    Genoplate CLI  | <--> |      Core Engine        |
| (Ввод пользователя)|      |    (Rust Crate)         |
+-------------------+      +-------------------------+
         ^                           ^
         |                           |
         v                           v
+-------------------+      +-------------------------+
|  User Preferences |      | Boilerplate Registry    |
|   (Config Files)  |      |  (Local/Remote Sources) |
+-------------------+      +-------------------------+
         ^                           ^
         |                           |
         v                           v
+-----------------------------------------------------+
|                     File System Operations          |
|                 (Чтение/Запись/Изменение файлов)    |
+-----------------------------------------------------+
```

*   **Genoplate CLI (Rust Crate):**
    *   Парсинг аргументов командной строки.
    *   Интерактивное взаимодействие с пользователем (выбор фичей) – можно использовать `inquire` или аналогичное.
    *   Вызов Core Engine с выбранными параметрами.
    *   Вывод логов и "next steps" для пользователя.
*   **Core Engine (Главный Rust Crate):**
    *   Загрузка и валидация конфигураций boilerplate-ов.
    *   Разрешение зависимостей между фичами.
    *   Применение "Rules Engine" для проверки совместимости (аналог `execRules` в BatiJS).
    *   Подготовка `GenMeta` объекта (аналог `VikeMeta`).
    *   Управление очередностью операций (аналог `OperationsRearranger`).
    *   Обработка файлов: копирование, трансформация, удаление.
    *   Выполнение хуков.
    *   Генерация `seed`.
*   **Boilerplate Registry:** Система для обнаружения и загрузки доступных boilerplate-ов.
    *   **Курируемый/Общий реестр:** Для широко используемых, проверенных boilerplate'ов (Elysia, Vite и т.д.), доступных через централизованный сервис или известный набор Git-репозиториев.
    *   **Некурируемый/Пользовательский реестр:** Для boilerplate'ов, созданных пользователями или компаниями для собственных нужд, которые не предназначены для публикации в общем реестре. Они хранятся локально, в частных Git-репозиториях или по указанным путям в файловой системе.
    *   Поддержка обнаружения из различных источников (удаленные URL-ы, локальные пути).
*   **Configuration Schema/Language:** Формат для определения boilerplate-ов.
    *   **Декларативное TOML/YAML:** Исключительно для метаданных boilerplate-а (название, описание, зависимости, правила) и определения базовых файловых операций.
    *   **Процедурная логика:** Сложная условная логика и трансформации должны быть вынесены в отдельные внешние скрипты (запускаемые через хуки) или инкапсулированы в переиспользуемые Rust-модули ядра `genoplate`, а не встраиваться напрямую в конфигурационный файл boilerplate'а.

**4. Ключевые Возможности**

*   **Модульные Boilerplate'ы:**
    *   Каждый boilerplate (фича) находится в отдельной директории (аналогично `boilerplates/` в BatiJS).
    *   Содержит конфигурационный файл (например, `genoplate.toml`), директорию с файлами (`files/`) и опционально директорию с хуками (`hooks/`).
    *   **Поддержка Языков:** В `genoplate.toml` можно будет указать, для каких языков применим данный boilerplate (`languages = ["rust", "typescript"]`).
*   **GenMeta Объект:**
    *   Единый `struct`/`enum` в Rust, хранящий выбранные пользователем фичи, версии, ENV-переменные, **список целевых языков (`target_languages: Vec<String>`)** и другую информацию, к которой boilerplate'ы имеют доступ для условной логики.
*   **Условная Логика:**
    *   Boilerplate'ы могут определять условия `if` (например, в `genoplate.toml` или через вызов Rust-функции), при которых они будут применены, основываясь на `GenMeta`, **включая проверку целевых языков**.
*   **Система Правил (Rules Engine):**
    *   Правила совместимости могут включать условия, зависящие от целевого языка (например, "feature ESLint применим только для TypeScript/JavaScript проектов").
*   **Файловые Операции:**
    *   **Копирование:** Простые копирование файлов из `boilerplates/<feature>/files/`.
    *   **Трансформация (по аналогии с `plopjs.actions`):** Задается явно в `genoplate.toml` для каждого файла:
        *   `type: "add"`: Добавление нового файла, если файл уже существует, может быть ошибка или запрос на перезапись.
        *   `type: "copy"`: Копирование файла из исходника.
        *   `type: "template"`: Копирование файла, используя его как шаблон (например, `Tera`) для генерации контента.
        *   `type: "modify"`: Изменение существующего файла (например, добавление строк, замена блоков, мердж JSON/TOML).
        *   `source`: Путь к исходному файлу в boilerplate'е.
        *   `destination`: Целевой путь в генерируемом проекте.
        *   `condition`: Условие, при котором выполняется данная операция (на основе `GenMeta`).
    *   Шаблонизатор (`Tera`): Используется для генерации любого текстового контента (Rust, TypeScript, JavaScript, конфигурации и т.д.).
    *   **Языко-специфичные трансформации (через хуки):** Более сложные изменения кода будут выполняться внешними утилитами, запускаемыми через хуки.
    *   **Гибкое сопоставление файлов:** Возможность иметь разные версии файлов для разных языков или условий, например, `main.rs.tera` и `main.ts.tera`, с выбором на основе `target_languages` или `GenMeta`.
    *   **Автоматическая чистка:** Удаление файлов, которые были добавлены boilerplate'ами, но не используются.
*   **Хуки (Hooks):**
    *   Поддержка запуска внешних команд/скриптов, определенных в `hooks/` директориях boilerplate'ов. Эти команды выполняются на определенных этапах генерации (например, `post-generation`).
    *   Rust-код в хуках может использоваться для более сложной оркестровки или взаимодействия с ядром `Genoplate`, но для языко-специфичных трансформаций рекомендуется использовать внешние утилиты (`prettier`, `rustfmt`).

**5. Rust-Специфичные Реализации**

*   **Структура Крейтов:**
    *   `genoplate-cli`: Крейт для командной строки.
    *   `genoplate-core`: Основная логика (ядро), содержит `GenMeta`, Rules Engine, файловые операции.
    *   `genoplate-config`: Определения структур для конфигурационных файлов (`genoplate.toml`).
    *   `genoplate-registry`: Менеджер для локальных/удаленных boilerplate'ов.
    *   **`genoplate-templating` (новый):** Крейт, отвечающий за логику общего текстового шаблонирования (например, через Tera/Handlebars), а также за базовые трансформации файлов. Он сосредоточен на обработке текста, а не на глубокой семантической или AST-обработке кода.
*   **Шаблонизация:** Интеграция `tera` или `handlebars` для обработки файлов шаблонов **для любого текстового формата (Rust, TS, JS, YAML, JSON и т.д.)**.

**6. Дорожная Карта / Будущие Улучшения**
*   **Централизованный Реестр Boilerplate'ов:** Удаленный сервис для поиска, публикации и управления boilerplate'ами.
*   **Web UI:** Веб-интерфейс для интерактивного создания сборок.
*   **Versioning:** Управление версиями boilerplate'ов и их зависимостей.
*   **Git Integration:** Улучшенная работа с Git (клонирование, инициализация, комиты).
