---
title: Design document
---

### **Дизайн-документ: Genoplate - Универсальный Генератор Boilerplate**

**1. Обзор и Видение Проекта**
*   **Цель:** Создание универсального Rust-приложения для генерации boilerplate-ов, позволяющего разработчикам легко комбинировать модульные компоненты (фичи, библиотеки) в кастомные сборки для **Rust и TypeScript** проектов, и обеспечивающего воспроизводимость через "generation seeds".
*   **Проблема:** Существующие Git-шаблоны и некоторые генераторы ограничены в гибкости, управлении зависимостями и возможности компоновки произвольных фичей.
*   **Решение:** `Genoplate` предоставляет модульную систему, где каждый компонент является "строительным блоком", который может быть выбран, сконфигурирован и сгенерирован в готовую проектную структуру.
*   **Целевая аудитория:** Разработчики, команды, создатели библиотек, которым требуется быстро создавать новые проекты с заранее определенным набором технологий и настроек.

**2. Ключевые Принципы Дизайна**
*   **Модульность:** Каждая "фича" (например, UI-фреймворк, база данных, линтер) является независимым, конфигурируемым модулем.
*   **Универсальность:** Возможность для пользователей определять и регистрировать собственные "сборки" (коллекции фичей с конфигурациями) для **различных языков программирования (Rust, TypeScript)**.
*   **Декларативность:** Определение boilerplate-ов и их логики через конфигурационные файлы (например, TOML или YAML).
*   **Гибкость:** Поддержка условной логики, преобразований файлов и хуков после генерации.
*   **Воспроизводимость:** Генерация "seed" — уникального идентификатора (хеша) входных параметров (выбранных boilerplate'ов, их версий и конфигураций), позволяющего точно воспроизвести процесс генерации. Seed кодирует *инструкции*, а не сам результат.
*   **Безопасность:** Минимизация рисков конфликтов и ошибок через систему правил и зависимостей.

**3. Архитектура Системы (Высокоуровневая)**

```
+-------------------+      +-------------------------+
|    Genoplate CLI  | <--> |      Core Engine        |
| (Ввод пользователя)|      |    (Rust Crate)         |
+-------------------+      +-------------------------+
         ^                           ^
         |                           |
         v                           v
+-------------------+      +-------------------------+
|  User Preferences |      | Boilerplate Registry    |
|   (Config Files)  |      |  (Local/Remote Sources) |
+-------------------+      +-------------------------+
         ^                           ^
         |                           |
         v                           v
+-----------------------------------------------------+
|                     File System Operations          |
|                 (Чтение/Запись/Изменение файлов)    |
+-----------------------------------------------------+
```

*   **Genoplate CLI (Rust Crate):**
    *   Парсинг аргументов командной строки.
    *   Интерактивное взаимодействие с пользователем (выбор фичей) – можно использовать `inquire` или аналогичное.
    *   Вызов Core Engine с выбранными параметрами.
    *   Вывод логов и "next steps" для пользователя.
*   **Core Engine (Главный Rust Crate):**
    *   Загрузка и валидация конфигураций boilerplate-ов.
    *   Разрешение зависимостей между фичами.
    *   Применение "Rules Engine" для проверки совместимости (аналог `execRules` в BatiJS).
    *   Подготовка `GenMeta` объекта (аналог `VikeMeta`).
    *   Управление очередностью операций (аналог `OperationsRearranger`).
    *   Обработка файлов: копирование, трансформация, удаление.
    *   Выполнение хуков.
    *   Генерация `seed`.
*   **Boilerplate Registry:** Система для обнаружения и загрузки доступных boilerplate-ов.
    *   **Курируемый/Общий реестр:** Для широко используемых, проверенных boilerplate'ов (Elysia, Vite и т.д.), доступных через централизованный сервис или известный набор Git-репозиториев.
    *   **Некурируемый/Пользовательский реестр:** Для boilerplate'ов, созданных пользователями или компаниями для собственных нужд, которые не предназначены для публикации в общем реестре. Они хранятся локально, в частных Git-репозиториях или по указанным путям в файловой системе.
    *   Поддержка обнаружения из различных источников (удаленные URL-ы, локальные пути).
*   **Configuration Schema/Language:** Формат для определения boilerplate-ов.
    *   **Декларативное TOML/YAML:** Исключительно для метаданных boilerplate-а (название, описание, зависимости, правила) и определения базовых файловых операций.
    *   **Процедурная логика:** Сложная условная логика и трансформации должны быть вынесены в отдельные внешние скрипты (запускаемые через хуки) или инкапсулированы в переиспользуемые Rust-модули ядра `genoplate`, а не встраиваться напрямую в конфигурационный файл boilerplate'а.

**4. Ключевые Возможности**

*   **Модульные Boilerplate'ы:**
    *   Каждый boilerplate (фича) находится в отдельной директории (аналогично `boilerplates/` в BatiJS).
    *   Содержит конфигурационный файл (например, `genoplate.toml`), директорию с файлами (`files/`) и опционально директорию с хуками (`hooks/`).
    *   **Метаданные Boilerplate'а (`genoplate.toml`):** Будут включать `name`, `description`, `version`, поддерживаемые `languages = ["rust", "typescript"]`, а также **совместимость с фреймворками** (`target_framework = { name = "elysia", min_version = "0.8.0", max_version = "1.x" }`).
*   **GenMeta Объект:**
    *   Единый `struct`/`enum` в Rust, хранящий выбранные пользователем фичи, версии, ENV-переменные, **список целевых языков (`target_languages: Vec<String>`)**, **версии базовых фреймворков и библиотек**, а также другую информацию, к которой boilerplate'ы имеют доступ для условной логики и валидации совместимости.
*   **Условная Логика и Валидация:**
    *   Boilerplate'ы могут определять условия `if` (например, в `genoplate.toml` или через вызов Rust-функции), при которых они будут применены, основываясь на `GenMeta`, **включая проверку совместимости с версиями фреймворков**. Эти условия также используются `Rules Engine` для валидации выборов пользователя.
*   **Система Правил (Rules Engine):**
    *   Правила совместимости могут включать условия, зависящие от целевого языка (например, "feature ESLint применим только для TypeScript/JavaScript проектов").
*  **Файловые Операции и Интеллектуальное Слияние:**
    *   `Genoplate` будет оркестрировать список файловых трансформаций, каждая из которых явно определена в `genoplate.toml`.
    *   **Типы Базовых Операций:**
        *   `type: "add"` / `type: "copy"` / `type: "template"`: Создание или копирование файлов/директорий, с использованием шаблонизатора (Tera/Handlebars) для динамического контента.
        *   `type: "remove"`: Удаление файла или директории.
        *   `type: "modify"`: Основная операция для интеллектуального изменения существующего контента.
    *   **Декларация `modify` Операций (Каскадный Синтаксис):**
        *   `genoplate.toml` будет содержать плоский список `[[transform_recipes.<имя>]]`, определяющих конкретные шаги модификации.
        *   `[[files]]` секция будет ссылаться на эти именованные рецепты через `applies_transforms = ["имя_рецепта"]`. Это позволит избежать глубокой вложенности и улучшить читаемость.
    *   **Стратегии Интеллектуальной Модификации (`modify.strategy`):**
        *   Ядро `Genoplate` предоставит широкий набор стратегий, каждая со своими параметрами:
            *   `strategy: "merge_json"` / `"merge_toml"`: Интеллектуальное слияние данных в JSON/TOML файлах (например, `package.json`, `.eslintrc`, `Cargo.toml`).
            *   `strategy: "insert_after_regex"` / `"insert_before_regex"`: Вставка содержимого относительно регулярного выражения.
            *   `strategy: "insert_after_tag"` / `"insert_before_tag"` / `"replace_tag"`: Использование специальных маркеров (тегов) в файлах (например, `// GENOPLATE_REGION: IMPORTS`), для точной и конфликт-устойчивой вставки/замены блоков кода.
            *   `strategy: "dependency_merge"`: Специализированная для объединения секций зависимостей в `package.json` или `Cargo.toml` с учетом версий и конфликтов.
        *   Каждая `modify` операция может иметь `condition` (на основе `GenMeta`) для условного применения.
    *   **Оркестрация и Разрешение Конфликтов:**
        *   Система `OperationsRearranger` (аналогично BatiJS) будет тщательно сортировать все файловые операции (включая модификации) от всех выбранных boilerplate'ов.
        *   При обнаружении потенциальных конфликтов (например, два boilerplate'а пытаются изменить одну и ту же строку без совместимой стратегии слияния):
            *   `Genoplate` будет пытаться разрешить их автоматически (например, путем упорядочивания или использования более сложной стратегии).
            *   В случае неразрешимого конфликта будет сигнализироваться ошибка или записываться `.genoplate-conflict` файл с указанием расхождений, позволяя пользователю вручную разрешить проблему.
    *   **Автоматическая чистка:** Удаление файлов, которые были добавлены boilerplate'ами, но не используются.
*   **Хуки (Hooks):**
    *   Поддержка запуска внешних команд/скриптов, определенных в `hooks/` директориях boilerplate'ов. Эти команды выполняются на определенных этапах генерации (например, `post-generation`).
    *   Rust-код в хуках может использоваться для более сложной оркестровки или взаимодействия с ядром `Genoplate`, но для языко-специфичных трансформаций рекомендуется использовать внешние утилиты (`prettier`, `rustfmt`).
    *   **Поддержка Современных Пакетных Менеджеров:** Хуки и логика boilerplate'ов будут учитывать выбор пользователя (или автоматическое определение) таких пакетных менеджеров, как `npm`, `yarn`, `pnpm`, `bun`, для выполнения соответствующих команд (`install`, `add`, `run`) и генерации специфичных файлов конфигурации.

**5. Rust-Специфичные Реализации**

*   **Структура Крейтов:**
    *   `genoplate-cli`: Крейт для командной строки.
    *   `genoplate-core`: Основная логика (ядро), содержит `GenMeta`, Rules Engine, файловые операции.
    *   `genoplate-config`: Определения структур для конфигурационных файлов (`genoplate.toml`).
    *   `genoplate-registry`: Менеджер для локальных/удаленных boilerplate'ов.
    *   **`genoplate-templating` (новый):** Крейт, отвечающий за логику общего текстового шаблонирования (например, через Tera/Handlebars), а также за базовые трансформации файлов. Он сосредоточен на обработке текста, а не на глубокой семантической или AST-обработке кода.
*   **Шаблонизация:** Интеграция `tera` или `handlebars` для обработки файлов шаблонов **для любого текстового формата (Rust, TS, JS, YAML, JSON и т.д.)**.

**6. Дорожная Карта / Будущие Улучшения**
*   **Централизованный Реестр Boilerplate'ов:** Удаленный сервис для поиска, публикации и управления boilerplate'ами.
*   **Web UI:** Веб-интерфейс для интерактивного создания сборок.
*   **Versioning:** Управление версиями boilerplate'ов и их зависимостей.
*   **Git Integration:** Улучшенная работа с Git (клонирование, инициализация, комиты).

```mermaid
graph TD
A[Пользовательский ввод / CLI] --> B(Genoplate CLI);
B --> C{Определение проекта};
C --> D[Загрузка Модулей Boilerplate из Реестра];
D --> E[Формирование GenMeta (Выборы, Языки, Версии)];
E --> F{Правила и Валидация (Rules Engine)};
F -- Конфликты / Ошибки --> G[Вывод Пользователю / Завершение];
F -- Ok --> H[Сбор и Оркестрация Файловых Операций (OperationsRearranger)];
H --> I[Применение Операций к Виртуальной ФС в Памяти (HashMap)];
I -- Разрешение Конфликтов / Слияние --> I;
I --> J{Результат в Памяти};
J --> K[Запись Окончательного Состояния на Диск];
K --> L[Выполнение Хуков (npm install, cargo build, etc.)];
L --> M[Очистка / Финализация (например, .genoplate-conflict)];
M --> N[Генерация Seed-а];
N --> O[Вывод Пользователю (Next Steps, Success)];
```